# AH_stocks 量化回测系统

本项目是一个基于 Tushare 数据的 A 股量化回测系统，旨在验证基于技术指标（主力吸货、风险、动量）的选股策略在历史数据上的表现。

## 1. 回测选股逻辑 (Stock Selection Logic)

为了避免“幸存者偏差”和“未来函数”，本系统采用了**动态股票池**机制，严格按照历史时间点可获取的信息进行选股。

### 1.1 动态股票池 (Dynamic Stock Pool)
系统根据历史财报发布时间窗口，在每年的特定日期更新股票池：
- **5月15日**: 使用一季报 (Q1) 数据筛选。
- **8月31日**: 使用中报 (Q2) 数据筛选。
- **10月31日**: 使用三季报 (Q3) 数据筛选。

### 1.2 基础过滤条件 (Basic Filters)
在每个调仓日，系统会筛选符合以下条件的股票：
- **市值**: > 400亿 (大盘股，流动性好)
- **市盈率 (PE-TTM)**: 10 < PE < 60 (估值合理)
- **成长性**: 对应财报周期的净利润同比增长率 > 0 (业绩增长)

### 1.3 评分系统 (Scoring System)
对进入股票池的股票，每日计算技术指标并打分，总分 >= 85 分触发买入信号。
- **主力吸货 (权重 40%)**: 基于价格波动和成交量形态判断主力资金流入情况。
- **风险控制 (权重 35%)**: 基于价格在近期波动范围的位置判断风险水平。
- **动量涨跌 (权重 25%)**: 基于 KDJ/Stoch 指标判断短期趋势强度。

## 2. 数据处理过程 (Data Processing)

1.  **数据获取**: 使用 Tushare Pro API 获取股票日线行情 (Open, High, Low, Close) 和复权因子。
2.  **指标计算**:
    - 使用向量化操作 (Vectorized Operations) 批量计算所有股票的技术指标。
    - 模拟同花顺/通达信的 SMA (平滑移动平均) 算法，确保指标计算准确。
3.  **数据清洗**:
    - 处理停牌、缺失数据。
    - 统一处理 Pandas 返回的数据类型 (如 Series vs Float)，防止计算错误。
    - **去重**: 严格去除重复的股票代码，防止重复交易。

## 3. 每日程序逻辑 (Daily Logic)

回测引擎按交易日历逐日推进，每日执行以下逻辑：

1.  **确定股票池**: 根据当前日期，锁定使用哪一期（最近一次调仓日）的股票池。
2.  **买入逻辑 (Buy)**:
    - **信号检查**: 检查**前一交易日**是否触发买入信号（总分 >= 85）。
    - **排序**: 将所有触发信号的股票按分数从高到低排序。
    - **资金检查**: 如果当前持仓未满 (Max 20只) 且现金充足 (> 5% 初始资金)。
    - **执行买入**: 以**当日开盘价 (Open)** 买入，仓位控制为总资金的 5%。
    - **防重**: 严格检查是否已持仓，禁止重复买入同一只股票。
3.  **卖出逻辑 (Sell)**:
    - **持仓检查**: 遍历当前持仓，计算持仓天数。
    - **止盈/止损/期限**: 目前策略为**固定持有期**模式。
    - **执行卖出**: 如果持仓达到 **45个交易日**，在**当日开盘价 (Open)** 卖出。
    - **结算**: 计算盈亏金额和收益率，更新现金账户。
4.  **净值更新 (Update Equity)**:
    - 计算当日总资产 = 剩余现金 + 持仓市值 (按当日收盘价计算)。
    - 记录每日净值曲线。

## 4. 结果展示 (Results)

回测结束后，系统会生成以下报告：

- **终端输出**:
    - 总回报率 (Total Return)
    - 年化回报率 (Annualized Return)
    - 夏普比率 (Sharpe Ratio) & 索提诺比率 (Sortino Ratio)
    - 最大回撤 (Max Drawdown)
    - 胜率 (Win Rate) & 盈亏比 (P/L Ratio)
- **图表 (`backtest_result.png`)**:
    - 策略净值曲线 vs 基准指数 (沪深300, 上证, 中证1000)。
    - 标示最大回撤区间。
    - 每日资产柱状图。
- **交易明细 (`backtest_trades.csv`)**:
    - 包含每一笔买入、卖出的详细记录（日期、代码、名称、价格、股数、盈亏金额、持仓天数等）。
    - 包含回测结束时的强制平仓记录 (HELD_END)，确保账面浮盈被正确统计。